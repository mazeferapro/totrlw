--util.AddNetworkString("pharyng")
--util.AddNetworkString("otos")
--util.AddNetworkString("ophtalm")
--util.AddNetworkString("ophtalm2")

function RegenMedicine(ply)
	ply:SetNWInt("MedicDisease", 100)
	ply:SetNWInt("MedicRhinitus", 100)
	ply:SetNWInt("MedicVirusPneumonitis", 100)
	ply:SetNWInt("MedicPharingitis", 100)
	ply:SetNWInt("MedicEustahiitis", 100)
	ply:SetNWInt("MedicAngiotensinicusHypertensia", 100)
	ply:SetNWInt("MedicVasopressicusHypertensia", 100)
	ply:SetNWInt("MedicHepatitisA", 100)
	ply:SetNWInt("MedicPyelonephritisLocalInfiltratus", 100)
	ply:SetNWInt("MedicPyelonephritisDiffususInfiltratus", 100)
	ply:SetNWInt("MedicPyelonephritisMesenhimicus", 100)
	ply:SetNWInt("Medicbacstenosisclapmitralis", 100)
	ply:SetNWInt("Medicavblock", 100)
	ply:SetNWInt("Medicfungendocarditis", 100)
	ply:SetNWInt("Medicmegaloblasticanemia", 100)
	ply:SetNWInt("Medichaemoliticanemia", 100)
	ply:SetNWInt("Medicdishaemopoeticanemia", 100)
	ply:SetNWInt("MedicOsephagitis", 100)
	ply:SetNWInt("MedicGastritis", 100)
	ply:SetNWInt("MedicDyodenitis", 100)
	ply:SetNWInt("MedicEunitis", 100)
	ply:SetNWInt("MedicIelitis", 100)
	ply:SetNWInt("MedicColitis", 100)
	ply:SetNWInt("MedicSigmoiditis", 100)
	ply:SetNWInt("MedicProctitis", 100)
	ply:SetNWInt("MedicPancreatitisexacerbatiosus", 100)
	ply:SetNWInt("MedicPancreatitispara", 100)
	ply:SetNWInt("MedicPancreatitissepticus", 100)
	ply:SetNWInt("MedicPancreatitishaemorragicus", 100)
	ply:SetNWInt("MedicPancreatitisinfiltratus", 100)
	ply:SetNWInt("MedicPancreatitisautoimmunicus", 100)
	ply:SetNWInt("MedicSialoadenitis", 100)
	ply:SetNWInt("Medicdisfarginasa", 100)
	ply:SetNWInt("Medicdisffumarat", 100)
	ply:SetNWInt("Medicdisforotocidyriae", 100)
	ply:SetNWInt("Medicpodagra", 100)
	ply:SetNWInt("Medichaerptonsilitis", 100)
	ply:SetNWInt("Mediccataralistonsillitis", 100)
	ply:SetNWInt("Mediclacunaristonsillitis", 100)
	ply:SetNWInt("Medicparatonsillitis", 100)
	ply:SetNWInt("Medicfibrisustonsillitis", 100)
	ply:SetNWInt("Medicfollicularistonsilitis", 100)
	ply:SetNWInt("Medicsinusitis", 100)
	ply:SetNWInt("Medicnasovestibulit", 100)
	ply:SetNWInt("Medicdiffususbronchitis", 100)
	ply:SetNWInt("Medicperibronchitis", 100)
	ply:SetNWInt("Medicoeosenophilistbronchitis", 100)
	ply:SetNWInt("Medicpyoobstructofibrosclerosusbronchitis", 100)
	ply:SetNWInt("Medicfibrosusalveolitits", 100)
	ply:SetNWInt("Medicdiffususnecroticusalveolitis", 100)
	ply:SetNWInt("Mediceccsudatusplevritis", 100)
	ply:SetNWInt("Medicfibrosusplevritis", 100)
	ply:SetNWInt("Medichysticytosis", 100)
	ply:SetNWInt("Medicmastocytosis", 100)
	ply:SetNWInt("Medicessencialitistrombicitaemia", 100)
	ply:SetNWInt("Mediccentralicatrombocitaemia", 100)
	ply:SetNWInt("Mediclangergansishystiocytosis", 100)
	ply:SetNWInt("Medicsystemicpoliangiit", 100)
	ply:SetNWInt("Medicnecroticperiarteriit", 100)
	ply:SetNWInt("Medicrevmaticpoliangiit", 100)
	ply:SetNWInt("Medicnecroticpoliangiit", 100)
	ply:SetNWInt("Medicglobulinaemicusflebidis", 100)
	ply:SetNWInt("Medicgranulematosispoliflebitis", 100)
	ply:SetNWInt("Mediccerebrovasculitis", 100)
	ply:SetNWInt("Medicacsonopaticpolinevritis", 100)
	ply:SetNWInt("Medicdemieliticnevritis", 100)
	ply:SetNWInt("Medicdiffususpolinevritis", 100)
	ply:SetNWInt("Medicrevmaticplexitis", 100)
	ply:SetNWInt("Medicexacerbatiosusradiculitis", 100)
	ply:SetNWInt("Medicencephalitis", 100)
	ply:SetNWInt("Medicserosusminengitis", 100)
	ply:SetNWInt("Medicprotozoaminengitis", 100)
	ply:SetNWInt("Medicspondilodiscitis", 100)
	ply:SetNWInt("Medicpyogenicusmielitis", 100)
	ply:SetNWInt("Mediceshemicusencephalopatia", 100)
	ply:SetNWInt("Medicgangliolitis", 100)
	ply:SetNWInt("Medicosteomielit", 100)
	ply:SetNWInt("Medicpyonephrosum", 100)
	ply:SetNWInt("Medicneprosclerosis", 100)
	ply:SetNWInt("Medicglomerulonefritisfast", 100)
	ply:SetNWInt("Medicdiffususglomerulonephritis", 100)
	ply:SetNWInt("Medicuretritis", 100)
	ply:SetNWInt("Mediccystitis", 100)
	ply:SetNWInt("Medicacantomediasiskeratitis", 100)
	ply:SetNWInt("Medicophtalmoangiopathia", 100)
	ply:SetNWInt("Medicconjunktivitis", 100)
	ply:SetNWInt("Medicdacryoadenitis", 100)
	ply:SetNWInt("Mediciridocyclitis", 100)
	ply:SetNWInt("Medickeratit", 100)
	ply:SetNWInt("Medicxenophtalmia", 100)
	ply:SetNWInt("Medicinfiltratusopticusneuropathia", 100)
	ply:SetNWInt("Medicpanaphtalmitis", 100)
	ply:SetNWInt("Medicretinitis", 100)
	ply:SetNWInt("Medicinfiltratusscleritis", 100)
	ply:SetNWInt("Medicuveitis", 100)
	ply:SetNWInt("Medicendophtalmitis", 100)
	ply:SetNWInt("Medicepiscleritis", 100)
	ply:SetNWInt("Medicmeibomitis", 100)
	ply:SetNWInt("Medicblefaritis", 100)
	ply:SetNWInt("Medicneuromyotomia", 100)
	ply:SetNWInt("Medicdacryocystitis", 100)
	ply:SetNWInt("Medicotitisexterna", 100)
	ply:SetNWInt("Medicotitismedialis", 100)
	ply:SetNWInt("Medicololicvorea", 100)
	ply:SetNWInt("Medicotohaemotorea", 100)
	ply:SetNWInt("Medicotovestibulitis", 100)

	ply:SetNWInt("MedicIntoxication", 0)
	---------------------------
	------SURGERY MODULE-------
	---------------------------
	ply:SetNWInt("SurgeryModRaptureHeart", 0)
	ply:SetNWInt("SurgeryModRaptureAorta", 0)
	ply:SetNWInt("SurgeryModRaptureSpleen", 0)
	ply:SetNWInt("SurgeryModRaptureLung", 0)
	ply:SetNWInt("SurgeryModRaptureLiver", 0)
	ply:SetNWInt("SurgeryModRaptureKidney", 0)

	ply:SetNWInt("SurgeryModHematomaHeart", 0)
	ply:SetNWInt("SurgeryModHematomaAorta", 0)
	ply:SetNWInt("SurgeryModHematomaSpleen", 0)
	ply:SetNWInt("SurgeryModHematomaLung", 0)
	ply:SetNWInt("SurgeryModHematomaLiver", 0)
	ply:SetNWInt("SurgeryModHematomaKidney", 0)
	---------------------------
	-------TRAUMA MODULE-------
	---------------------------
	ply:SetNWInt("MedicineHead", 100)
	ply:SetNWInt("MedicineArm", 100)
	ply:SetNWInt("MedicineLeg", 100)
	ply:SetNWInt("MedicineStomach", 100)
	ply:SetNWInt("MedicineChest", 100)

	ply:SetNWInt("Mediccontusion", 100)

	ply:SetNWInt("Medichaveradiation", 0)
	ply:SetNWInt("Medichaveblood", 5000)

	ply:SetNWInt("Medicbleedingarterial", 0)
	ply:SetNWInt("Medicbleedingvenae", 0)

	ply:SetNWInt("Medictraumaarm", 0)
	ply:SetNWInt("Medictraumacostae", 0)
	ply:SetNWInt("Medictraumalegs", 0)
	ply:SetNWInt("Medictraumahead", 0)
	ply:SetNWInt("Medictraumastomach", 0)
	ply:SetNWInt("Medictraumapenis", 0)

	ply:SetNWInt("Medicacutarm", 0)
	ply:SetNWInt("Medicacutcostae", 0)
	ply:SetNWInt("Medicacutlegs", 0)
	ply:SetNWInt("Medicacuthead", 0)
	ply:SetNWInt("Medicacutstomach", 0)
	ply:SetNWInt("Medicacutpenis", 0)

	ply:SetNWInt("Medicinjuryarm", 0)
	ply:SetNWInt("Medicinjurycostae", 0)
	ply:SetNWInt("Medicinjurylegs", 0)
	ply:SetNWInt("Medicinjuryhead", 0)
	ply:SetNWInt("Medicinjurystomach", 0)
	ply:SetNWInt("Medicinjurypenis", 0)
end

local NoTraumaJobs = {
    -- Добавьте нужные профессии
}

local NoTraumaSIDs = {
	--['STEAM_0:1:127564031'] = true, -- Raven
	--['STEAM_0:0:54343242'] = true, -- Kudere
}

-- Функция проверки иммунитета
local function HasTraumaImmunity(ply)
    if not IsValid(ply) or not ply:IsPlayer() then return false end
    if NoTraumaSIDs[ply:SteamID()] then return true end

    -- Получаем название команды игрока
    local teamName = team.GetName(ply:Team())
    if not teamName then return false end

    return NoTraumaJobs[teamName]
end

function MedicDamage(ply,hitgroup,dmginfo)
	local EnableBleeding = false
	local EnableInteralTraum = false
	local EnableTraum = true
	if HasTraumaImmunity(ply) then
        return -- Просто выходим, травм не будет
    end

	local dmgpos = dmginfo:GetDamagePosition()

	local PelvisIndx = ply:LookupBone("ValveBiped.Bip01_Pelvis")
	if (PelvisIndx == nil) then return dmginfo end
	local PelvisPos = ply:GetBonePosition( PelvisIndx )
	local NutsDistance = dmgpos:Distance(PelvisPos)

	local LHandIndex = ply:LookupBone("ValveBiped.Bip01_L_Hand")
	local LHandPos = ply:GetBonePosition( LHandIndex )
	local LHandDistance = dmgpos:Distance(LHandPos)

	local RHandIndex = ply:LookupBone("ValveBiped.Bip01_R_Hand")
	local RHandPos = ply:GetBonePosition(RHandIndex)
	local RHandDistance = dmgpos:Distance(RHandPos)

	--[[if dmginfo:IsDamageType(DMG_BLAST) then
		if ServerMedicMod.EnableContusion == true then
			ply:SetNWInt("Mediccontusion", ply:GetNWInt("Mediccontusion") - 1)
		end
	end]]--

	if (NutsDistance <= 7 && NutsDistance >= 5) then
		hitgroup = 98
	elseif (LHandDistance < 6 || RHandDistance < 6 ) then
		hitgroup = 99
	end
	if (hitgroup == HITGROUP_HEAD) then
		dmginfo:ScaleDamage(4)
		if EnableTraum == true then
			ply:SetNWInt("MedicineHead", ply:GetNWInt("MedicineHead")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumahead", 1)
				if math.random(1,2) == 1 then
					ply:SetNWInt("Medicbleedingarterial", 1)
				else
					ply:SetNWInt("Medicbleedingvenae", 1)
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjuryhead", 1)
			else
				ply:SetNWInt("Medicacuthead", 1)
				if math.random(1,2) == 1 then
					ply:SetNWInt("Medicbleedingarterial", 1)
				else
					ply:SetNWInt("Medicbleedingvenae", 1)
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif (hitgroup == HITGROUP_LEFTARM || hitgroup == HITGROUP_RIGHTARM) then
		dmginfo:ScaleDamage(0.5)
		if EnableTraum == true then
			ply:SetNWInt("MedicineArm", ply:GetNWInt("MedicineArm")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumaarm", 1)
				if math.random(1,2) == 1 then
					ply:SetNWInt("Medicbleedingarterial", 1)
				else
					ply:SetNWInt("Medicbleedingvenae", 1)
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjuryarm", 1)
			else
				ply:SetNWInt("Medicacutarm", 1)
				if math.random(1,2) == 1 then
					ply:SetNWInt("Medicbleedingarterial", 1)
				else
					ply:SetNWInt("Medicbleedingvenae", 1)
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif (hitgroup == HITGROUP_LEFTLEG || hitgroup == HITGROUP_RIGHTLEG) then
		dmginfo:ScaleDamage(0.5)
		if EnableTraum == true then
			ply:SetNWInt("MedicineLeg", ply:GetNWInt("MedicineLeg")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumalegs", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjurylegs", 1)
			else
				ply:SetNWInt("Medicacutlegs", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif (hitgroup == HITGROUP_CHEST) then
		if EnableInteralTraum == true then
			local rand1 = math.random(1,2)
			if rand1 == 1 then
				local rand2 = math.random(1,100)
				local rand3 = math.random(1,100)
				if rand2 <= 50 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureLung",1)
					else
						ply:SetNWInt("SurgeryModHematomaLung",1)
					end
				elseif rand2 <= 100 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureHeart",1)
					else
						ply:SetNWInt("SurgeryModHematomaHeart",1)
					end
				end
			end
		end
		if EnableTraum == true then
			ply:SetNWInt("MedicineChest", ply:GetNWInt("MedicineChest")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumacostae", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjurycostae", 1)
			else
				ply:SetNWInt("Medicacutcostae", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif (hitgroup == HITGROUP_STOMACH) then
		dmginfo:ScaleDamage(0.75)
		if EnableInteralTraum == true then
			local rand1 = math.random(1,3)
			if rand1 == 1 then
				local rand2 = math.random(1,100)
				local rand3 = math.random(1,100)
				if rand2 <= 25 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureKidney",1)
					else
						ply:SetNWInt("SurgeryModHematomaKidney",1)
					end
				elseif rand2 <= 50 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureLiver",1)
					else
						ply:SetNWInt("SurgeryModHematomaLiver",1)
					end
				elseif rand2 <= 75 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureSpleen",1)
					else
						ply:SetNWInt("SurgeryModHematomaSpleen",1)
					end
				elseif rand2 <= 100 then
					if rand3 > 50 then
						ply:SetNWInt("SurgeryModRaptureAorta",1)
					else
						ply:SetNWInt("SurgeryModHematomaAorta",1)
					end
				end
			end
		end
		if EnableTraum == true then
			ply:SetNWInt("MedicineStomach", ply:GetNWInt("MedicineStomach")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumastomach", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
				elseif rand == 2 then
				ply:SetNWInt("Medicinjurystomach", 1)
			else
				ply:SetNWInt("Medicacutstomach", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif (hitgroup == 98) then
		dmginfo:ScaleDamage(0.75)
		if EnableTraum == true then
			ply:SetNWInt("MedicineStomach", ply:GetNWInt("MedicineStomach")-25)
			local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumapenis", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjurypenis", 1)
			else
				ply:SetNWInt("Medicacutpenis", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
		end
	elseif(hitgroup == 99) then
		dmginfo:ScaleDamage(0.4)
		ply:SetNWInt("MedicineArm", ply:GetNWInt("MedicineArm")-25)
		local rand = math.random(1,3)
			if rand == 1 then
				ply:SetNWInt("Medictraumaarm", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("npc/barnacle/neck_snap1.wav")
			elseif rand == 2 then
				ply:SetNWInt("Medicinjuryarm", 1)
			else
				ply:SetNWInt("Medicacutarm", 1)
				if EnableBleeding == true then
					if math.random(1,2) == 1 then
						ply:SetNWInt("Medicbleedingarterial", 1)
					else
						ply:SetNWInt("Medicbleedingvenae", 1)
					end
				end
				ply:EmitSound("physics/body/body_medium_impact_hard2.wav")
			end
	end
end

function MedicFallDamage(ply,speed)
    local damage = speed / 15

    local jt = ply:getJobTable()
    if istable(jt) then
	    if jt.type == TYPE_JEDI then return false end
	end
    -- Проверяем иммунитет от травм
    if HasTraumaImmunity(ply) then
        return damage -- Урон остается, но травм от падения не будет
    end

    -- Оригинальный код травм от падения
    if (damage > ply:Health() / 4 and damage < ply:Health()) then
        ply:SetNWInt("Medictraumalegs", 1)
        ply:SetNWInt("MedicineLeg", ply:GetNWInt("MedicineLeg")-40)
    end
    return damage
end

hook.Add("ScalePlayerDamage","MedicinePlayerDamage", MedicDamage)
hook.Add("ScaleNPCDamage","MedicineNPCDamage", MedicDamage)
hook.Add("GetFallDamage","MedicineFallDamage", MedicFallDamage)
hook.Add("PlayerSpawn","MedicineSpawn", RegenMedicine)